<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Dashboard - TOMITECH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card-hover { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .stat-card { position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .stat-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Chart container styling */
        canvas { max-height: 250px; }
        
        /* ============================================
           RESPONSIVE DESIGN - Mobile, Tablet, Desktop
           ============================================ */
        
        /* Tablet (max-width: 1024px) */
        @media (max-width: 1024px) {
            .container {
                padding: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
        }
        
        /* Mobile Large (max-width: 768px) */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            canvas {
                max-height: 200px;
            }
        }
        
        /* Mobile Small (max-width: 480px) */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }
            
            .stat-card {
                padding: 0.5rem;
            }
            
            canvas {
                max-height: 150px;
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            button,
            a.button {
                min-height: 44px; /* Minimum touch target size */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 min-h-screen">
    
    <!-- Navigation -->
    <nav class="gradient-bg shadow-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-10"></div>
        <div class="max-w-7xl mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-4">
                    <a href="../../index.html" class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-leaf mr-3 text-3xl"></i>
                        <span class="bg-gradient-to-r from-white to-green-100 bg-clip-text text-transparent">
                            ðŸŒ± TOMITECH
                        </span>
                    </a>
                    <span class="bg-white/20 text-green-100 px-4 py-2 rounded-full text-sm font-bold">
                        Policy Dashboard
                    </span>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="../../index.html" class="text-white/90 hover:text-white transition-all">
                        <i class="fas fa-home mr-2"></i>Beranda
                    </a>
                    <button onclick="logout()" class="bg-red-500/90 text-white px-6 py-3 rounded-full hover:bg-red-600 transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
        
        <!-- Header -->
        <div class="text-center mb-6 sm:mb-8 relative">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 bg-clip-text text-transparent mb-2">
                Policy Dashboard
            </h1>
            <p class="text-sm sm:text-base text-gray-600 font-medium">Analisis Data Green Accounting untuk Kebijakan UMKM</p>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-3 sm:gap-4 mb-8">
            <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-3 sm:p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-green-100 text-xs font-medium mb-1">UMKM</p>
                        <p class="text-2xl sm:text-3xl font-bold mb-0.5 stat-pulse" id="totalUMKM">156</p>
                        <p class="text-green-200 text-xs hidden sm:block">Terdaftar</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-building text-base sm:text-lg"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-3 sm:p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-blue-100 text-xs font-medium mb-1">Eco-Score</p>
                        <p class="text-2xl sm:text-3xl font-bold mb-0.5 stat-pulse" id="avgEcoScore">78</p>
                        <p class="text-blue-200 text-xs hidden sm:block">Rata-rata</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-leaf text-base sm:text-lg"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-3 sm:p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-purple-100 text-xs font-medium mb-1">Limbah</p>
                        <p class="text-2xl sm:text-3xl font-bold mb-0.5 stat-pulse" id="totalWaste">2.4T</p>
                        <p class="text-purple-200 text-xs hidden sm:block">Dikelola</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-recycle text-base sm:text-lg"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-3 sm:p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-orange-100 text-xs font-medium mb-1">Nilai Ekonomi</p>
                        <p class="text-2xl sm:text-3xl font-bold mb-0.5 stat-pulse" id="totalEconomicValue">Rp 12.5M</p>
                        <p class="text-orange-200 text-xs hidden sm:block">Total</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-coins text-base sm:text-lg"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-gradient-to-br from-teal-500 to-teal-600 rounded-lg shadow-lg p-3 sm:p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-teal-100 text-xs font-medium mb-1">Efisiensi</p>
                        <p class="text-2xl sm:text-3xl font-bold mb-0.5 stat-pulse" id="avgEfficiency">23%</p>
                        <p class="text-teal-200 text-xs hidden sm:block">Penghematan</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-chart-line text-base sm:text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4">
                <h3 class="text-sm sm:text-base font-semibold text-gray-800 mb-3">Distribusi Eco-Score UMKM</h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="eco-score-distribution-chart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4">
                <h3 class="text-sm sm:text-base font-semibold text-gray-800 mb-3">Laporan Input Data</h3>
                <div class="space-y-3">
                    <!-- Latest Activity Card -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-leaf text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">Aktivitas Terbaru</p>
                                    <p class="text-xs text-gray-600">10 menit lalu</p>
                                </div>
                            </div>
                            <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-semibold">+12</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mt-3">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-green-600">45</p>
                                <p class="text-xs text-gray-600">Total Input</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-blue-600">28</p>
                                <p class="text-xs text-gray-600">Bulan Ini</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-purple-600">17</p>
                                <p class="text-xs text-gray-600">Minggu Ini</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Summary -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-bar text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">Statistik Data</p>
                                    <p class="text-xs text-gray-600">Trend bulanan</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <div class="bg-white rounded-lg p-2">
                                <p class="text-xs text-gray-600 mb-1">Rata-rata per hari</p>
                                <p class="text-lg font-bold text-blue-600">3.2</p>
                            </div>
                            <div class="bg-white rounded-lg p-2">
                                <p class="text-xs text-gray-600 mb-1">Pertumbuhan</p>
                                <p class="text-lg font-bold text-green-600">+8%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laporan Input Data -->
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-lg p-3 sm:p-4 mb-6 border border-white/50">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-database text-white text-sm sm:text-base"></i>
                    </div>
                    <h2 class="text-lg sm:text-xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                        Laporan Input Data
                    </h2>
                </div>
                <button onclick="exportData()" class="px-3 py-1.5 text-xs sm:text-sm bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:shadow-lg transition-all flex items-center gap-1 justify-center">
                    <i class="fas fa-download text-xs"></i><span>Export CSV</span>
                </button>
            </div>

            <!-- Data Analytics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 mb-4">
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg shadow-md p-4 border border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-leaf text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-xs font-semibold text-gray-800">Total Data</h3>
                                <p class="text-2xl font-bold text-green-600">1,245</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-600">
                        <i class="fas fa-arrow-up text-green-600"></i>
                        <span>+12% dari bulan lalu</span>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-md p-4 border border-blue-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-users text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-xs font-semibold text-gray-800">Pengguna Aktif</h3>
                                <p class="text-2xl font-bold text-blue-600">342</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-600">
                        <i class="fas fa-clock text-blue-600"></i>
                        <span>Hari ini</span>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg shadow-md p-4 border border-purple-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-chart-line text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-xs font-semibold text-gray-800">Eco-Score</h3>
                                <p class="text-2xl font-bold text-purple-600">85</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-600">
                        <i class="fas fa-star text-purple-600"></i>
                        <span>Rata-rata</span>
                    </div>
                </div>
            </div>

            <!-- Recent Data Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-xs sm:text-sm">
                        <thead class="bg-gradient-to-r from-green-50 to-emerald-50">
                            <tr>
                                <th class="px-3 py-2 text-left font-semibold text-gray-700">Tanggal</th>
                                <th class="px-3 py-2 text-left font-semibold text-gray-700">Nama</th>
                                <th class="px-3 py-2 text-left font-semibold text-gray-700">Jenis</th>
                                <th class="px-3 py-2 text-left font-semibold text-gray-700">Jumlah</th>
                                <th class="px-3 py-2 text-left font-semibold text-gray-700">Eco-Score</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-green-50 transition-colors">
                                <td class="px-3 py-2 text-gray-600">15 Jan 2024</td>
                                <td class="px-3 py-2 font-semibold text-gray-800">John Doe</td>
                                <td class="px-3 py-2"><span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">Plastik</span></td>
                                <td class="px-3 py-2 text-gray-600">25 kg</td>
                                <td class="px-3 py-2"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">92</span></td>
                            </tr>
                            <tr class="hover:bg-green-50 transition-colors">
                                <td class="px-3 py-2 text-gray-600">15 Jan 2024</td>
                                <td class="px-3 py-2 font-semibold text-gray-800">Jane Smith</td>
                                <td class="px-3 py-2"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">Kertas</span></td>
                                <td class="px-3 py-2 text-gray-600">15 kg</td>
                                <td class="px-3 py-2"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">88</span></td>
                            </tr>
                            <tr class="hover:bg-green-50 transition-colors">
                                <td class="px-3 py-2 text-gray-600">14 Jan 2024</td>
                                <td class="px-3 py-2 font-semibold text-gray-800">Bob Johnson</td>
                                <td class="px-3 py-2"><span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">Organik</span></td>
                                <td class="px-3 py-2 text-gray-600">30 kg</td>
                                <td class="px-3 py-2"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">95</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Green Reports -->
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-lg p-3 sm:p-4 mb-6 border border-white/50">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-chart-line text-white text-sm sm:text-base"></i>
                </div>
                <div>
                    <h2 class="text-lg sm:text-xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                        Green Reports
                    </h2>
                    <p class="text-xs text-gray-600">Analisis & Laporan Dampak Lingkungan UMKM</p>
                </div>
            </div>

            <!-- Report Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- Card 1 -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200 hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-leaf text-white text-lg"></i>
                        </div>
                        <span class="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-semibold">Aktif</span>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">UMKM Sari Rasa</h3>
                    <p class="text-xs text-gray-600 mb-3">Produksi Makanan</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center">
                            <p class="text-lg font-bold text-green-600">250kg</p>
                            <p class="text-xs text-gray-600">Limbah</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600">Rp 1.2M</p>
                            <p class="text-xs text-gray-600">Nilai</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-purple-600">85</p>
                            <p class="text-xs text-gray-600">Score</p>
                        </div>
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200 hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-bolt text-white text-lg"></i>
                        </div>
                        <span class="px-3 py-1 bg-blue-500 text-white rounded-full text-xs font-semibold">Hemat</span>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">Warung Kopi Santai</h3>
                    <p class="text-xs text-gray-600 mb-3">Beverage Service</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center">
                            <p class="text-lg font-bold text-green-600">-15%</p>
                            <p class="text-xs text-gray-600">Penghematan</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600">Rp 800K</p>
                            <p class="text-xs text-gray-600">Listrik</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-purple-600">92</p>
                            <p class="text-xs text-gray-600">Score</p>
                        </div>
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-200 hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-recycle text-white text-lg"></i>
                        </div>
                        <span class="px-3 py-1 bg-purple-500 text-white rounded-full text-xs font-semibold">Recycle</span>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">Kerajinan Lokal</h3>
                    <p class="text-xs text-gray-600 mb-3">Handicraft & Artisan</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center">
                            <p class="text-lg font-bold text-green-600">120kg</p>
                            <p class="text-xs text-gray-600">Daur Ulang</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600">Rp 950K</p>
                            <p class="text-xs text-gray-600">Ekonomi</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-purple-600">88</p>
                            <p class="text-xs text-gray-600">Score</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-green-600"></i>
                    Ringkasan Statistik
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-xs text-gray-600 mb-1">Total UMKM</p>
                        <p class="text-2xl font-bold text-green-600">342</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600 mb-1">Rata-rata Score</p>
                        <p class="text-2xl font-bold text-blue-600">87</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600 mb-1">Total Limbah</p>
                        <p class="text-2xl font-bold text-purple-600">5.2T</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600 mb-1">Nilai Ekonomi</p>
                        <p class="text-2xl font-bold text-orange-600">Rp 2.1B</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-6 right-6 px-8 py-4 rounded-2xl shadow-2xl z-50 opacity-0 transform translate-y-4 transition-all duration-500 backdrop-blur-sm border border-white/20"></div>

    <script type="module">
        import { db, auth } from '../../config/firebase-init.js';
        import { deleteDoc, collection, onSnapshot, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getQuizAnalytics } from '../../assets/js/quiz/quiz-firestore-service.js';
        
        let scoreChart = null;
        let surveyRatingsChart = null;
        let surveyDevicesChart = null;
        let surveyFeaturesChart = null;

        window.deleteSurveyResponse = async function (id) {
          if (!confirm('Yakin ingin menghapus response ini?')) return;

          try {
            await deleteDoc(doc(db, 'survey_responses', id));
            showNotification('Ã¢Å“â€¦ Response berhasil dihapus', 3000);

            // refresh list
            if (typeof loadSurveyResponses === 'function') {
              await loadSurveyResponses();
            }
          } catch (err) {
            console.error('Ã¢ÂÅ’ Gagal menghapus response:', err);
            showNotification(`Gagal hapus response: ${err.message}`, 4000);
          }
        };

        /* === Helper Notif === */
        function showNotification(message, duration = 3000) {
          const notif = document.getElementById('notification');
          notif.innerHTML = message;
          notif.className = 'fixed top-6 right-6 px-8 py-4 rounded-2xl shadow-2xl z-50 bg-white/90 border border-gray-200 text-gray-800 font-semibold opacity-100 translate-y-0 transition-all duration-500';
          setTimeout(() => { notif.classList.add('opacity-0','translate-y-4'); }, duration);
        }

        /* === Materials Management Disabled === */
        // Materials management has been disabled as Supabase is no longer used


        /* === Delete Materi === */
        window.deleteMateri = async function(fileName) {
          showNotification('âŒ Delete disabled - Supabase integration removed');
        };

        /* === Realtime listeners === */
        function setupRealtimeListeners() {
          // Users
          onSnapshot(collection(db, 'userStats'), (snap) =>
            updateStat('totalUsers', snap.size));

          // Forum posts
          onSnapshot(collection(db, 'posts'), (snap) =>
            updateStat('totalForumPosts', snap.size));

          // Quiz sessions
          onSnapshot(collection(db, 'quizResults'), (snap) =>
            updateStat('totalQuizSessions', snap.size));

          // Survey responses
          onSnapshot(collection(db, 'surveyResponses'), (snap) => {
            updateStat('totalSurveyResponses', snap.size);
            displaySurveyResponses(snap);
          });

          // Materials disabled (Supabase removed)
        }
        
        /* === Helper update === */
        function updateStat(statId, value) {
          const el = document.getElementById(statId);
          if (!el) return;
          el.textContent = value;
          el.classList.add('stat-pulse');
          setTimeout(() => el.classList.remove('stat-pulse'), 2000);
        }

        /* === Update Survey Charts === */
        function updateSurveyCharts(responses) {
          if (!responses || responses.length === 0) {
            // Show empty state for charts
            ['survey-ratings-chart', 'survey-devices-chart', 'survey-features-chart'].forEach(id => {
              const canvas = document.getElementById(id);
              if (canvas) {
                const parent = canvas.parentElement;
                parent.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-400 text-sm">Belum ada data</p></div>';
              }
            });
            return;
          }

          // 1. Calculate average ratings per category
          const ratingCategories = {
            textReadability: 'Teks Mudah Dibaca',
            colorLayout: 'Warna & Layout',
            attractiveDesign: 'Desain Menarik',
            crossPlatform: 'Lintas Platform',
            easeOfUse: 'Kemudahan',
            chatbotRelevance: 'Chatbot',
            mediaSupport: 'Media',
            materialClarity: 'Kejelasan Materi',
            questionVariety: 'Variasi Soal',
            learningSupport: 'Dukungan Belajar'
          };

          const ratingAverages = {};
          Object.keys(ratingCategories).forEach(key => {
            const ratings = responses.map(r => r.ratings?.[key]).filter(v => typeof v === 'number');
            ratingAverages[key] = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
          });

          // 2. Count devices
          const deviceCounts = {};
          responses.forEach(r => {
            const device = r.device || 'Unknown';
            deviceCounts[device] = (deviceCounts[device] || 0) + 1;
          });

          // 3. Count favorite features
          const featureCounts = {};
          responses.forEach(r => {
            const feature = r.favoriteFeature || 'Unknown';
            featureCounts[feature] = (featureCounts[feature] || 0) + 1;
          });

          // Render charts
          renderSurveyRatingsChart(ratingCategories, ratingAverages);
          renderSurveyDevicesChart(deviceCounts);
          renderSurveyFeaturesChart(featureCounts);
        }

        function renderSurveyRatingsChart(categories, averages) {
          const ctx = document.getElementById('survey-ratings-chart');
          if (!ctx) return;

          const labels = Object.values(categories);
          const data = Object.keys(categories).map(key => averages[key]);

          if (surveyRatingsChart) {
            surveyRatingsChart.data.labels = labels;
            surveyRatingsChart.data.datasets[0].data = data;
            surveyRatingsChart.update();
          } else {
            surveyRatingsChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Rating Rata-rata',
                  data: data,
                  backgroundColor: 'rgba(249, 115, 22, 0.6)',
                  borderColor: 'rgba(249, 115, 22, 1)',
                  borderWidth: 2,
                  borderRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: { stepSize: 1 }
                  },
                  x: {
                    ticks: {
                      font: { size: 10 },
                      maxRotation: 45,
                      minRotation: 45
                    }
                  }
                },
                plugins: {
                  legend: { display: false }
                }
              }
            });
          }
        }

        function renderSurveyDevicesChart(deviceCounts) {
          const ctx = document.getElementById('survey-devices-chart');
          if (!ctx) return;

          const labels = Object.keys(deviceCounts);
          const data = Object.values(deviceCounts);
          const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

          if (surveyDevicesChart) {
            surveyDevicesChart.data.labels = labels;
            surveyDevicesChart.data.datasets[0].data = data;
            surveyDevicesChart.update();
          } else {
            surveyDevicesChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: labels,
                datasets: [{
                  data: data,
                  backgroundColor: colors.slice(0, labels.length),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: { font: { size: 11 } }
                  }
                }
              }
            });
          }
        }

        function renderSurveyFeaturesChart(featureCounts) {
          const ctx = document.getElementById('survey-features-chart');
          if (!ctx) return;

          const labels = Object.keys(featureCounts);
          const data = Object.values(featureCounts);
          const colors = ['#6366f1', '#14b8a6', '#f97316', '#ec4899', '#84cc16', '#06b6d4'];

          if (surveyFeaturesChart) {
            surveyFeaturesChart.data.labels = labels;
            surveyFeaturesChart.data.datasets[0].data = data;
            surveyFeaturesChart.update();
          } else {
            surveyFeaturesChart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: labels,
                datasets: [{
                  data: data,
                  backgroundColor: colors.slice(0, labels.length),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: { font: { size: 11 } }
                  }
                }
              }
            });
          }
        }

        /* === Survey list card === */
        function displaySurveyResponses(snapshot) {
          const container = document.getElementById('survey-responses-list');
          if (!container) return;

          if (snapshot.empty) {
            container.innerHTML = `
              <div class="text-center py-12 text-gray-500">
                <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                <p>Belum ada survey response</p>
              </div>`;
            return;
          }

          const responses = [];
          snapshot.forEach(doc => responses.push({ id: doc.id, ...doc.data() }));

          responses.sort((a,b)=> (b.timestamp?new Date(b.timestamp).getTime():0) - (a.timestamp?new Date(a.timestamp).getTime():0));

          // Update survey charts
          updateSurveyCharts(responses);
        
          container.innerHTML = responses.map(r=>{
            const avgRating = calculateAverageRating(r.ratings);
            return `
              <div class="bg-white rounded-lg p-3 sm:p-4 shadow-md border border-gray-200 hover:shadow-lg transition-all">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-3">
                  <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-sm sm:text-base text-gray-800 truncate">${r.userName||'Anonymous'}</h4>
                    <p class="text-xs text-gray-500 truncate">${r.userEmail||'No email'}</p>
                    <p class="text-xs text-gray-400 mt-1">${r.timestamp?new Date(r.timestamp).toLocaleString('id-ID'):'No date'}</p>
                  </div>
                  <div class="flex gap-2 flex-shrink-0">
                    <button onclick="viewSurveyDetail('${r.id}')"
                      class="px-3 py-1.5 text-xs sm:text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1">
                      <i class="fas fa-eye text-xs"></i><span class="hidden sm:inline">Detail</span>
                    </button>
                    <button onclick="deleteSurveyResponse('${r.id}')"
                      class="px-3 py-1.5 text-xs sm:text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-1">
                      <i class="fas fa-trash text-xs"></i><span class="hidden sm:inline">Hapus</span>
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                  <div class="bg-blue-50 p-2 rounded-lg">
                    <p class="text-xs text-blue-600 font-medium mb-0.5">Perangkat</p>
                    <p class="text-xs font-bold text-blue-800 truncate">${r.device||'N/A'}</p>
                  </div>
                  <div class="bg-green-50 p-2 rounded-lg">
                    <p class="text-xs text-green-600 font-medium mb-0.5">Fitur Favorit</p>
                    <p class="text-xs font-bold text-green-800 truncate">${r.favoriteFeature||'N/A'}</p>
                  </div>
                  <div class="bg-purple-50 p-2 rounded-lg">
                    <p class="text-xs text-purple-600 font-medium mb-0.5">Tujuan</p>
                    <p class="text-xs font-bold text-purple-800 truncate">${r.purpose||'N/A'}</p>
                  </div>
                  <div class="bg-orange-50 p-2 rounded-lg">
                    <p class="text-xs text-orange-600 font-medium mb-0.5">Frekuensi</p>
                    <p class="text-xs font-bold text-orange-800 truncate">${r.frequency||'N/A'}</p>
                  </div>
                </div>

                <div class="bg-gray-50 p-2 rounded-lg">
                  <p class="text-xs text-gray-600 font-medium mb-1">Rating Rata-rata</p>
                  <div class="flex items-center">
                    <span class="text-xl font-bold text-yellow-600">${avgRating}</span>
                    <span class="text-xs text-gray-500 ml-1">/ 5.0</span>
                  </div>
                </div>
              </div>`;
          }).join('');
        }
    
        function calculateAverageRating(ratings) {
          if (!ratings || typeof ratings!=='object') return 'N/A';
          const vals=Object.values(ratings).filter(v=>typeof v==='number');
          if (!vals.length) return 'N/A';
          return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
        }
        
        function formatRatingKey(key){
          const labels={
            textReadability:'Teks Mudah Dibaca',
            colorLayout:'Warna dan Tata Letak',
            attractiveDesign:'Desain Menarik',
            crossPlatform:'Lintas Platform',
            easeOfUse:'Kemudahan Penggunaan',
            chatbotRelevance:'Relevansi Chatbot',
            mediaSupport:'Media Pendukung',
            materialClarity:'Kejelasan Materi',
            questionVariety:'Variasi Soal',
            learningSupport:'Dukungan Pembelajaran'
          };
          return labels[key]||key;
        }
        
        /* === Modal detail survey dengan info tambahan === */
        function showSurveyModal(data){
          const modal=document.createElement('div');
          modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
          modal.onclick=(e)=>{if(e.target===modal)modal.remove();};
        
          const ratingsHTML=data.ratings?Object.entries(data.ratings).map(([k,v])=>`
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600 mb-2">${formatRatingKey(k)}</p>
              <div class="flex items-center">
                <div class="flex-1 bg-gray-200 h-2 rounded-full overflow-hidden">
                  <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 h-full" style="width:${(v/5)*100}%"></div>
                </div>
                <span class="ml-3 font-bold text-yellow-600">${v}/5</span>
              </div>
            </div>`).join(''):'<p class="text-gray-500">No ratings available</p>';
        
          modal.innerHTML=`
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">${data.userName||'Anonymous'}</h2>
                  <p class="text-gray-600">${data.userEmail||'No email'}</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <i class="fas fa-times text-xl text-gray-600"></i>
                </button>
              </div>
        
              <!-- Tambahan info di modal -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-blue-50 p-3 rounded-lg">
                  <p class="text-xs text-blue-600 font-medium">Perangkat</p>
                  <p class="text-sm font-bold text-blue-800">${data.device||'N/A'}</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                  <p class="text-xs text-green-600 font-medium">Fitur Favorit</p>
                  <p class="text-sm font-bold text-green-800">${data.favoriteFeature||'N/A'}</p>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                  <p class="text-xs text-purple-600 font-medium">Tujuan</p>
                  <p class="text-sm font-bold text-purple-800">${data.purpose||'N/A'}</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg">
                  <p class="text-xs text-orange-600 font-medium">Frekuensi</p>
                  <p class="text-sm font-bold text-orange-800">${data.frequency||'N/A'}</p>
                </div>
              </div>
        
              <div class="space-y-6">
                <div>
                  <h3 class="text-lg font-bold text-gray-800 mb-4">Detail Penilaian</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${ratingsHTML}
                  </div>
                </div>
                ${data.additionalFeedback?`
                  <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Saran & Masukan</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <p class="text-gray-700">${data.additionalFeedback}</p>
                    </div>
                  </div>`:''}
              </div>
            </div>`;
          document.body.appendChild(modal);
        }
        
        /* supaya onclick berfungsi */
        window.viewSurveyDetail=async function(surveyId){
          try{
            const docSnap=await getDoc(doc(db,'surveyResponses',surveyId));
            if(docSnap.exists()){
              showSurveyModal(docSnap.data());
            }else alert('Survey tidak ditemukan');
          }catch(e){
            console.error('Error fetching survey detail:',e);
            alert('Gagal memuat detail survey');
          }
        };
        
        /* === Chart quiz analytics === */
        async function loadQuizAnalytics(){
          try {
            console.log('ðŸ“Š Loading quiz analytics...');
            const analytics = await getQuizAnalytics();

            if (!analytics) {
              console.warn('âš ï¸ No analytics data available');
              return;
            }

            console.log('âœ… Analytics loaded:', analytics);

            const scoreCtx = document.getElementById('eco-score-distribution-chart')?.getContext('2d');
            if (!scoreCtx) {
              console.error('âŒ Eco-score chart canvas not found');
              return;
            }

            // Sample data for green accounting
            const ecoScoreLabels = ['0-20', '21-40', '41-60', '61-80', '81-100'];
            const ecoScoreValues = [12, 28, 45, 52, 19]; // Sample UMKM distribution

            if (scoreChart) {
              scoreChart.data.labels = ecoScoreLabels;
              scoreChart.data.datasets[0].data = ecoScoreValues;
              scoreChart.update();
            } else {
              scoreChart = new Chart(scoreCtx, {
                type: 'bar',
                data: {
                  labels: ecoScoreLabels,
                  datasets: [{
                    label: 'Jumlah UMKM',
                    data: ecoScoreValues,
                    backgroundColor: '#10b981',
                    borderRadius: 8
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  animation: false,
                  plugins: {
                    legend: {
                      display: false
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        stepSize: 5
                      }
                    }
                  }
                }
              });
            }

            console.log('âœ… Charts rendered successfully');
          } catch (error) {
            console.error('âŒ Error loading quiz analytics:', error);
          }
        }
        
        /* === Logout === */
        window.logout = async function() {
          try {
            await auth.signOut();
            window.location.href = '../auth/login.html';
          } catch (error) {
            console.error('âŒ Error logging out:', error);
            alert('Gagal logout');
          }
        };

        /* === Export Data to CSV === */
        window.exportData = async function() {
          try {
            alert('Fitur export data akan segera tersedia');
          } catch (error) {
            console.error('âŒ Error exporting data:', error);
            alert('Gagal export data');
          }
        };

        /* === Export Surveys to CSV === */
        window.exportSurveys = async function() {
          try {
            const snapshot = await getDocs(collection(db, 'surveyResponses'));
            if (snapshot.empty) {
              alert('Tidak ada data survey untuk di-export');
              return;
            }

            let csvContent = 'Nama,Email,Tanggal,Device,Fitur Favorit,Tujuan,Frekuensi,Rating Rata-rata\n';

            snapshot.forEach(doc => {
              const data = doc.data();
              const avgRating = calculateAverageRating(data.ratings);
              const row = [
                data.userName || 'Anonymous',
                data.userEmail || 'No email',
                data.timestamp ? new Date(data.timestamp).toLocaleString('id-ID') : 'No date',
                data.device || 'N/A',
                data.favoriteFeature || 'N/A',
                data.purpose || 'N/A',
                data.frequency || 'N/A',
                avgRating
              ].map(field => `"${field}"`).join(',');
              csvContent += row + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `survey_responses_${new Date().getTime()}.csv`;
            link.click();

            showNotification('âœ… Survey berhasil di-export!');
          } catch (error) {
            console.error('âŒ Error exporting surveys:', error);
            alert('Gagal export survey: ' + error.message);
          }
        };

        /* === Init === */
        document.addEventListener('DOMContentLoaded',()=>{
          setupRealtimeListeners();
          loadQuizAnalytics();
        });
    </script>
    <script type="module" src="../../assets/js/auth/auth-guard.js"></script>
</body>
</html>