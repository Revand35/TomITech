<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data Tanaman - TOMITECH</title>
    <meta name="theme-color" content="#2c4d32">
    
    <!-- Preconnect for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- TOMITECH Design System -->
    <link rel="stylesheet" href="../../assets/css/tomitech-design-system.css">
    
    <style>
        .main-content {
            padding: var(--spacing-md);
            padding-bottom: 100px;
        }
        
        .info-box {
            border-left: 4px solid;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        /* ============================================
           RESPONSIVE DESIGN - Mobile, Tablet, Desktop
           ============================================ */
        
        /* Tablet (max-width: 1024px) */
        @media (max-width: 1024px) {
            .main-content {
                padding: var(--spacing-md);
            }
        }
        
        /* Mobile Large (max-width: 768px) */
        @media (max-width: 768px) {
            .main-content {
                padding: var(--spacing-sm);
            }
        }
        
        /* Mobile Small (max-width: 480px) */
        @media (max-width: 480px) {
            .main-content {
                padding: var(--spacing-xs);
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px; /* Minimum touch target size */
            }
        }
    </style>
    <!-- auth.js removed - using firebase-init.js instead to avoid conflicts -->
</head>
<body>
    <!-- Header -->
    <header class="tomitech-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="../../assets/icons/AgriHouse.png" alt="AgriHouse" style="width: 32px; height: 32px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-leaf" style="display:none; color: white; font-size: 1.5rem;"></i>
                </div>
                <div class="logo-text">
                    <div class="logo-title">
                        Input Data Greenhouse
                        <span class="page-indicator input">
                            <i class="fas fa-file-alt"></i>
                            Input Data
                        </span>
                    </div>
                    <div class="logo-subtitle">Catat data sensor dan aktivitas tanaman</div>
                </div>
            </div>
            <button class="action-btn" onclick="window.history.back()" title="Kembali">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </header>
    
    <main class="main-content">
        <!-- Form Input Tanaman -->
        <div class="tomitech-card">
            <h2 class="tomitech-card-title">
                <i class="fas fa-seedling" style="color: var(--tomitech-green-accent); margin-right: var(--spacing-sm);"></i>
                Input Data Greenhouse untuk AI Prediction
            </h2>
            
            <!-- Tab Navigation - Removed, only Sensor Data needed -->
            
            <!-- Sensor Data Form (untuk LSTM) -->
            <div id="sensor-tab">
                <form id="sensor-form" class="space-y-6">
                    <div class="info-box" style="background: #e3f2fd; padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                        <p style="font-size: 0.875rem; color: #1976d2;">
                            <strong>ðŸ“Š Untuk Prediksi LSTM:</strong> Input data sensor ini akan digunakan untuk prediksi mikroklimat 1-3 jam ke depan. Data akan disimpan sebagai time-series untuk analisis pola.
                        </p>
                    </div>
                    
                    <!-- Suhu -->
                    <div class="tomitech-form-group">
                        <label class="tomitech-form-label">
                            <i class="fas fa-thermometer-half" style="color: var(--red); margin-right: var(--spacing-xs);"></i>
                            Suhu (Â°C) <span style="color: var(--red);">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="temperature" 
                            name="temperature" 
                            class="tomitech-form-input" 
                            placeholder="Contoh: 25"
                            step="0.1"
                            min="0"
                            max="50"
                            required
                        >
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Rentang optimal: 20-30Â°C</small>
                    </div>
                    
                    <!-- Kelembaban -->
                    <div class="tomitech-form-group">
                        <label class="tomitech-form-label">
                            <i class="fas fa-tint" style="color: var(--blue); margin-right: var(--spacing-xs);"></i>
                            Kelembaban (%) <span style="color: var(--red);">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="humidity" 
                            name="humidity" 
                            class="tomitech-form-input" 
                            placeholder="Contoh: 65"
                            step="0.1"
                            min="0"
                            max="100"
                            required
                        >
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Rentang optimal: 40-70%</small>
                    </div>
                    
                    <!-- Level Cahaya -->
                    <div class="tomitech-form-group">
                        <label class="tomitech-form-label">
                            <i class="fas fa-sun" style="color: var(--orange); margin-right: var(--spacing-xs);"></i>
                            Level Cahaya (lux) <span style="color: var(--red);">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="light-level" 
                            name="lightLevel" 
                            class="tomitech-form-input" 
                            placeholder="Contoh: 5000"
                            min="0"
                            required
                        >
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Rentang optimal: 3000-8000 lux</small>
                    </div>
                    
                    <!-- Kelembaban Tanah -->
                    <div class="tomitech-form-group">
                        <label class="tomitech-form-label">
                            <i class="fas fa-seedling" style="color: var(--tomitech-green-accent); margin-right: var(--spacing-xs);"></i>
                            Kelembaban Tanah (%) <span style="color: var(--red);">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="soil-moisture" 
                            name="soilMoisture" 
                            class="tomitech-form-input" 
                            placeholder="Contoh: 55"
                            step="0.1"
                            min="0"
                            max="100"
                            required
                        >
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Rentang optimal: 40-70%</small>
                    </div>
                    
                    <!-- Catatan Sensor -->
                    <div class="tomitech-form-group">
                        <label class="tomitech-form-label">
                            Catatan Sensor (Opsional)
                        </label>
                        <textarea 
                            id="sensor-notes" 
                            name="sensorNotes" 
                            class="tomitech-form-textarea" 
                            placeholder="Tambahkan catatan tentang kondisi sensor..."
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <button type="submit" class="tomitech-btn primary full-width">
                        <i class="fas fa-save"></i>
                        Simpan Data Sensor
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Info Box -->
        <div class="tomitech-card" style="background: #e3f2fd; border-left: 4px solid var(--blue); margin-top: var(--spacing-lg);">
            <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                <i class="fas fa-info-circle" style="color: var(--blue); font-size: 1.25rem; margin-top: 2px;"></i>
                <div>
                    <h3 style="font-weight: 600; color: #1565c0; margin-bottom: var(--spacing-xs);">ðŸ’¡ Informasi Data Sensor</h3>
                    <div style="font-size: 0.875rem; color: #1976d2; line-height: 1.6;">
                        <p><strong>ðŸ“Š Data Sensor:</strong> Digunakan untuk prediksi LSTM (mikroklimat 1-3 jam ke depan). Data akan disimpan sebagai time-series untuk analisis pola.</p>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: var(--radius-lg); padding: var(--spacing-xl); text-align: center;">
            <div class="loading-spinner" style="width: 48px; height: 48px; border-width: 4px; margin: 0 auto var(--spacing-md);"></div>
            <p style="color: var(--text-primary); font-weight: 600;">Menyimpan data...</p>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="tomitech-bottom-nav">
        <a href="../../dashboard.html" class="tomitech-nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="chat.html" class="tomitech-nav-item">
            <div class="ai-assistant-nav-icon">
                <i class="fas fa-robot ai-robot-icon"></i>
                <i class="fas fa-sparkles ai-sparkle"></i>
                <i class="fas fa-sparkles ai-sparkle"></i>
                <i class="fas fa-sparkles ai-sparkle"></i>
            </div>
            <span>AI Assistant</span>
        </a>
        <a href="plant-input.html" class="tomitech-nav-item active">
            <i class="fas fa-file-alt"></i>
            <span>Input Data</span>
        </a>
        <a href="monitoring.html" class="tomitech-nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Monitoring</span>
        </a>
        <a href="profil.html" class="tomitech-nav-item">
            <i class="fas fa-user"></i>
            <span>Profil</span>
        </a>
    </nav>
    
    <script type="module">
        // Import services
        import { auth } from '../../config/firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { 
            saveSensorData,
            getUserGreenhouses,
            createGreenhouse
        } from '../../assets/js/greenhouse/greenhouse-service.js';
        import { showNotification } from '../../config/config.js';
        
        // Form submission
        const loadingOverlay = document.getElementById('loading-overlay');
        
        let currentUser = null;
        let currentGreenhouseId = null;
        
        // Get current user and greenhouse
        // Wait for Firebase auth to be ready before checking
        let authInitialized = false;
        let redirectTimeout = null;
        
        // First, check current user immediately (might be cached)
        if (auth.currentUser) {
            console.log('âœ… User already authenticated:', auth.currentUser.email);
            currentUser = auth.currentUser;
            authInitialized = true;
            
            // Load greenhouse data
            (async () => {
                try {
                    const greenhousesResult = await getUserGreenhouses(auth.currentUser.uid);
                    
                    if (greenhousesResult.success && greenhousesResult.data.length > 0) {
                        currentGreenhouseId = greenhousesResult.data[0].id;
                        console.log('âœ… Using existing greenhouse:', currentGreenhouseId);
                    } else {
                        const newGreenhouse = await createGreenhouse(auth.currentUser.uid, {
                            name: 'Greenhouse Saya',
                            location: ''
                        });
                        
                        if (newGreenhouse.success) {
                            currentGreenhouseId = newGreenhouse.id;
                            console.log('âœ… Created new greenhouse:', currentGreenhouseId);
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error getting/creating greenhouse:', error);
                }
            })();
        }
        
        // Then listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            // Clear any pending redirect
            if (redirectTimeout) {
                clearTimeout(redirectTimeout);
                redirectTimeout = null;
            }
            
            if (user) {
                console.log('âœ… User authenticated:', user.email);
                currentUser = user;
                authInitialized = true;
                
                // Get user's greenhouse or create one if doesn't exist
                try {
                    const greenhousesResult = await getUserGreenhouses(user.uid);
                    
                    if (greenhousesResult.success && greenhousesResult.data.length > 0) {
                        // Use the first greenhouse
                        currentGreenhouseId = greenhousesResult.data[0].id;
                        console.log('âœ… Using existing greenhouse:', currentGreenhouseId);
                    } else {
                        // Create a new greenhouse for the user
                        const newGreenhouse = await createGreenhouse(user.uid, {
                            name: 'Greenhouse Saya',
                            location: ''
                        });
                        
                        if (newGreenhouse.success) {
                            currentGreenhouseId = newGreenhouse.id;
                            console.log('âœ… Created new greenhouse:', currentGreenhouseId);
                        } else {
                            console.error('âŒ Failed to create greenhouse:', newGreenhouse.error);
                            showNotification('Gagal membuat greenhouse. Silakan refresh halaman.', 'error');
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error getting/creating greenhouse:', error);
                    showNotification('Gagal memuat data greenhouse: ' + error.message, 'error');
                }
            } else {
                // Only redirect after giving Firebase time to initialize (2 seconds)
                if (!authInitialized) {
                    redirectTimeout = setTimeout(() => {
                        // Double check - maybe auth just initialized
                        if (!auth.currentUser) {
                            console.log('âš ï¸ No user logged in after initialization, redirecting to login...');
                            window.location.href = '../../login.html';
                        }
                    }, 2000);
                } else {
                    // Auth was initialized but user logged out
                    console.log('âš ï¸ User logged out, redirecting to login...');
                    window.location.href = '../../login.html';
                }
            }
        });
        
        // Sensor Form Handler
        const sensorForm = document.getElementById('sensor-form');
        if (sensorForm) {
            sensorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentUser) {
                    showNotification('Silakan login terlebih dahulu', 'error');
                    return;
                }
                
                if (!currentGreenhouseId) {
                    showNotification('Sedang memuat data greenhouse. Silakan tunggu sebentar...', 'error');
                    return;
                }
                
                loadingOverlay.style.display = 'flex';
                
                try {
                    console.log('ðŸ’¾ Saving sensor data...', {
                        userId: currentUser.uid,
                        greenhouseId: currentGreenhouseId
                    });
                    
                    const sensorData = {
                        temperature: document.getElementById('temperature').value,
                        humidity: document.getElementById('humidity').value,
                        lightLevel: document.getElementById('light-level').value,
                        soilMoisture: document.getElementById('soil-moisture').value,
                        notes: document.getElementById('sensor-notes').value
                    };
                    
                    console.log('ðŸ“Š Sensor data to save:', sensorData);
                    
                    const result = await saveSensorData(
                        currentUser.uid,
                        currentGreenhouseId,
                        sensorData
                    );
                    
                    console.log('ðŸ“¥ Save result:', result);
                    
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                    
                    // Simpan info data terbaru untuk notifikasi di chat
                    sessionStorage.setItem('latestDataInput', JSON.stringify({
                        type: 'sensor',
                        data: sensorData,
                        timestamp: new Date().toISOString()
                    }));
                    
                    showNotification('Data sensor berhasil disimpan! Akan digunakan untuk prediksi LSTM.', 'success');
                    
                    // Reset form
                    setTimeout(() => {
                        sensorForm.reset();
                        loadingOverlay.style.display = 'none';
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error saving sensor data:', error);
                    showNotification('Gagal menyimpan data sensor: ' + error.message, 'error');
                    loadingOverlay.style.display = 'none';
                }
            });
        }
        
    </script>
    <!-- Navigation Indicator -->
    <script type="module">
        import { initNavigationIndicator } from '../../assets/js/core/navigation-indicator.js';
        document.addEventListener('DOMContentLoaded', () => {
            initNavigationIndicator();
        });
    </script>
</body>
</html>
